# Sync Dev Engineering Workspaces
#
# Triggered when a PR is merged to main. Syncs DEV workspaces from Git
# using the Git sync API (DEV workspaces are connected to Git).
#
# Flow: PR merged to main -> DEV Workspaces updated via Git sync

name: Sync Dev Engineering Workspaces

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  sync-dev-workspaces:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r config/requirements.txt

      - name: Sync DEV workspaces
        env:
          SPN_CLIENT_ID: ${{ secrets.SPN_CLIENT_ID }}
          SPN_CLIENT_SECRET: ${{ secrets.SPN_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          GITHUB_ACTIONS: true
          PYTHONUTF8: 1
          PYTHONIOENCODING: utf-8
          TARGET_ENVIRONMENT: dev
          WORKSPACES_TO_SYNC: processing,datastores
        run: |
          chcp 65001
          python config/scripts/sync_environment_workspaces.py
